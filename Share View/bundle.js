tau.mashups.addDependency("Underscore").addDependency("jQuery").addDependency("tau/configurator").addDependency("ShareBoard/ShareBoard.config").addDependency("ShareBoard/shareTemplate").addDependency("ShareBoard/manageTemplate").addDependency("ShareBoard/buttonTemplate").addCSS("ShareBoard.css").addMashup(function(_,$,configurator,config,shareTemplate,manageTemplate,buttonTemplate){"use strict";var serviceUrl=config.serviceUrl;var title=config.title||"Share %s";var capturionGroup="tauboard_user_shares_"+(window.loggedUser||{id:0}).id;var reg=configurator.getBusRegistry();var gb=configurator.getGlobalBus();var storage=configurator.getRestStorage();var makeCb=function(cb){return function(){cb.apply(null,_.rest(_.toArray(arguments)))}};var addBusListener=function(busName,eventName,listener){reg.on("create",makeCb(function(data){var bus=data.bus;if(bus.name===busName){bus.on(eventName,listener)}}));reg.on("destroy",makeCb(function(data){var bus=data.bus;if(bus.name===busName){bus.removeListener(eventName,listener)}}))};var acid;var boardId;var context;gb.on("acid.ready",function(evt,data){acid=data});gb.on("definition.ready",function(evt,definition){boardId=definition.boardId});gb.on("application.context.data",function(evt,data){context=data});var getContextDesc=function(){if(!context){return""}var parseAbbr=function(nodeName){return _.pluck(context[nodeName]||[],"abbreviation")};var value=parseAbbr("selectedTeams").concat(parseAbbr("selectedProjects")).join(",");if(value.length>200){value=value.substr(0,200)+"..."}return value};var getKeyUnique=function(){if(acid&&boardId){return boardId+"_"+acid}};var auth=$.ajax({type:"GET",url:configurator.getApplicationPath()+"/api/v1/authentication?format=json"}).then(function(data){return data.Token});var createShare=function(){return $.when(auth).then(function(token){var data={tick:(new Date).getTime(),serviceUrl:serviceUrl,boardId:boardId,acid:acid,title:document.title,system:window.tauSystemInfo||{},token:token,host:configurator.getApplicationPath(),user:window.loggedUser||{id:0},viewportSize:{width:window.innerWidth,height:window.innerHeight}};return $.ajax({method:"POST",url:serviceUrl+"/capture/",data:JSON.stringify(data),contentType:"application/json",processData:false,dataType:"json"})}).then(function(capture){var key=getKeyUnique();var captureTitle=document.title+" ("+getContextDesc()+")";var url=capture.url;return storage.data(capturionGroup,key,{url:url,title:captureTitle})})};var removeShare=function(key,url){return $.when(auth).then(function(token){return $.ajax({method:"POST",url:serviceUrl+"/stop/"+url,data:JSON.stringify({token:token}),contentType:"application/json",processData:false,dataType:"json"})}).then(function(){return storage.remove(capturionGroup,{$key:key})})};var renderShare=function($parent){return $.when(getKeyUnique()).then(function(key){return $.when(storage.data(capturionGroup,key),key)}).then(function(data,key){return $(shareTemplate({share:data.value,key:key,serviceUrl:serviceUrl}))}).then(function($el){$el.on("click",".i-role-remove-share",function(e){e.stopPropagation();e.preventDefault();var key=$(this).data("key");var url=$(this).data("url");removeShare(key,url).then(function(){return renderShare($parent)})});$el.on("click",".i-role-create-share",function(e){e.stopPropagation();e.preventDefault();$(e.target).attr("disabled","disabled");createShare().then(function(){return renderShare($parent)})});$el.on("click",".i-role-manage-shares",function(e){e.stopPropagation();e.preventDefault();return renderManage($parent)});return $el}).then(function($el){$parent.html($el);return $el})};var renderManage=function($parent){return storage.select(capturionGroup,{$where:{scope:"private"},$fields:["key","userData.url as url","userData.title as title"]}).then(function(res){return $(manageTemplate({shares:res.data,serviceUrl:serviceUrl}))}).then(function($el){$el.on("click",".i-role-remove-share",function(e){e.stopPropagation();e.preventDefault();$(e.target).parents("li:first").css("opacity",.5);$(e.target).remove();var key=$(this).data("key");var url=$(this).data("url");removeShare(key,url).then(function(){return renderManage($parent)})});$el.on("click",".i-role-current-share",function(e){e.stopPropagation();e.preventDefault();return renderShare($parent)});return $el}).then(function($el){$parent.html($el)})};addBusListener("actions-bubble","afterRenderAll",function(evt,renderData){var $parent=renderData.element;var definition=renderData.data.model;var isMode=["board","timeline"].indexOf(definition.viewMode)>=0;if(!isMode){return}if(config.removeOld){setTimeout(function(){$parent.find('[class="tau-board-actions-item share-board-action"]').remove()},100)}var buttonTitle=_.sprintf(title,_.capitalize(definition.viewMode));var $el=$(buttonTemplate({title:buttonTitle}));$parent.append($el);var $content=$("<div />");renderShare($content);$el.find("button").tauBubble({className:"tau-share-board-bubble",content:$content,onPositionConfig:function(bubbleConfig){bubbleConfig.at="center bottom";bubbleConfig.my="center top"},onShow:function($element){$element.css("z-index",1e3);$(".tau-in-text",$element).focus().select()}})})});tau.mashups.addDependency("Underscore").addModule("ShareBoard/buttonTemplate",function(_){"use strict";var s=['<div class="tau-board-actions-item share-board-action shareboard">','<span class="share-board">','<div class="tau-inline-group">',"<div>",'<button type="button" class="tau-btn tau-share-board-button tau-board-customize-beta">',"<%=title %>","</button>","</div>","</div>","</span>",'<div class="tau-txt">Share the view with the whole world.</div>',"</div>"].join("");return _.template(s)});tau.mashups.addDependency("Underscore").addModule("ShareBoard/manageTemplate",function(_){"use strict";var s=['<div class="tau-share-content">',"<h3>Shared views</h3>",'<ul class="tau-boards-list">',"<% shares.forEach(function(share) { %> ","<li>",'<a href="<%= serviceUrl %>/v/<%= share.url %>" class="tau-board-item" target="_blank" title="<%= share.title %>">','<span class="tau-board-name"><%= share.title %></span>',"</a>",'<a class="tau-remove i-role-remove-share" data-key="<%= share.key %>" data-url="<%= share.url %>">Remove</a>',"</li>","<% }); %>","<% if (shares.length == 0) { %>","<li>You have no shared views</li>","<% } %>","</ul>","</div>",'<div class="tau-distinct">','<div class="tau-actions"><a class="tau-board-shares-main i-role-current-share">Share View Menu</a></div>',"</div>"].join("");return _.template(s)});tau.mashups.addDependency("Underscore").addModule("ShareBoard/shareTemplate",function(_){"use strict";var s=['<div class="tau-share-content">',"<% if (!share) { %>",'<button type="button" class="tau-btn tau-board-new-share i-role-create-share">Share this view</button>','<span class="tau-txt tau-board-new-share">with anyone</span>',"<% } %>","<% if (share) { %>",'<textarea class="tau-in-text tau-existing-share" readonly="readonly"><%= serviceUrl %>/v/<%= share.url %></textarea>','<div class="tau-link-actions tau-existing-share">','<a class="tau-remove i-role-remove-share" data-key="<%= key %>" data-url="<%= share.url %>">Remove</a>','<span class="tau-open">Copy link or <a target="_blank" href="<%= serviceUrl %>/v/<%= share.url %>">Open the page</a></span>',"</div>","<% } %>","<div class=\"tau-note\">There's no need to grant permissions for that, so don't give this link to bad guys. The ","snapshot will refresh every two minutes with the card, zoom and focus currently applied to this view.","</div>","</div>",'<div class="tau-distinct">','<div class="tau-actions"><a class="tau-board-shares-manage i-role-manage-shares">Manage your public views</a></div>',"</div>"].join("");return _.template(s)});